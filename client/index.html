<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Lokaverkefni</title>
  <link rel="stylesheet" href="./client/css/styles.css">
  <link rel="stylesheet" href="./client/css/fireworks.css">
</head>

<body>
  <div class="gameContainer">
    <div class="sideBar">
      <div class="Headerinn" id="headTitle"></div>
      <img class="heads" id="playerHeads">
      <div id="grad1">
        <div id="bar">
          <div id ="status"></div>
        </div>
      </div>
    </div>
    <canvas id="myCanvas" width="640" height="640" style="border: 1px solid black;"> Sorry, but your browser does not support the HTML5 canvas tag.</canvas>
</div>
        
   
  <div class="firstViewContainer" id="videoContainerinn">
      <video class="myVideo" src="/client/videos/frontPic.mp4" autoplay="" muted></video>
      <div class="players">
        <h2 id ="one"></h2>
        <h2 id ="two"></h2>
        <h2 id ="three"></h2>
      </div>
    </div>
    <video id="myVideoBackground" src="/client/videos/frontPic.mp4" autoplay="" muted></video>
      
    </div>
    <div class="fireWorksContainer" id = "fireWorksContainerID">
      <div class="pyro">
        <div class="before"></div>
        <div class="after"></div>
      </div>
    </div>
  <!-- ------------------HTML END SCRIPTS START --------------------------------------->

  <!-- We need this to communicate using socket.io from client side -->
  <script src="/socket.io/socket.io.js"></script>
  <script> 
    const g_canvas = document.getElementById("myCanvas");
    const g_ctx = g_canvas.getContext("2d");
    const socket = io();// establish our communication
    let g_readyForNextRound = false;
    let g_steps=[];
  </script>
  
  <!-- include all client game logic such as drawing the map waiting looby etc -->
  <script src="./client/js/imagesPreload.js"></script>
  <script src="./client/js/utils.js"></script>
  <script src="./client/js/playerMovement.js"></script>
  <script src="./client/js/handleMouse.js"></script>
  <script src="./client/js/Sprite.js"></script>
  <script src="./client/js/main.js"></script>
  <script src ="./client/js/firstView.js"></script>
  <script src="./client/js/progressBar.js"></script>
  <script src="./client/js/staminaScores.js"></script>
  <script src="./client/js/animation.js"></script>
  <script src="./client/js/audioPlayer.js"></script>


 
  <!-- Combine all the game logic into a client side game -->
  <script>
    /* Define what happens when a socket manages to connect to our server */
    socket.on('connect', function() {
      // in here we can pass our socket.id to the functions that need it
      
      /* Next game round is send to us every x-seconds here we recive the map
      and call the necessary functions needed to draw the map based off 
      the data recived */
      drawPlayers();
      socket.on('NextGameRound', (data)=> {
        // we check if this is a map and in the proccesses check if the game is over 
        if (data.hasOwnProperty("__gameWon")) {
          // check if the game is over by players
          if(data.__gameWon.players){
            gameOver("Players");
          }
          // check if the game is over by monaster
          else if(data.__gameWon.monster) {
            gameOver("Monster");
          }
        }
          allPlayerReady(data);
          drawMapViaTiles(data, socket.id);
      });

      socket.on('roundstart', ()=> {
        // when the round starts we allow the user to click on the tiles
        window.addEventListener("mousedown", handleMouse);
        window.addEventListener("mousemove", handleMouse);
        
        
        player = getPlayer();
        setStamina(player);

        // start the count down that the user has 5 seconds to make a move
        startProgressBar();
        // declare that the client is not ready for the next round 
        // (NOT THIS ROUND BUT THE NEXT THAT IS YET TO BE CALCULATED AND RENDERED)
        g_readyForNextRound=false;
        
        /* Set a lambda function to go off in 5 seconds that will emit to the server what 
           has the user done, clearing the client side on what has he done and removing
           the listeners so he cant select the tiles*/
        setTimeout(() => {
          socket.emit('clientinput',{ steps:g_steps, powerUp:false});
          g_steps = [];
          window.removeEventListener("mousedown",handleMouse);
          window.removeEventListener("mousemove",handleMouse);
          moveMen();
        }, 5000);

      });
      

      /* Usage : gameOver(whowon)
           For : who won is a string telling who won
          After: calls the nessesary functions to end the game also emits
                 after 5 seconds a request to reset the game
      */
      function gameOver(whowon) {
        /* Helgi ur functions come here */
        console.log("GAME IS OVER THE ",whowon," has won the game");
        victorySound();
        setTimeout(() => { socket.emit('resetgamerequest',null); }, 8000);
      }

      /* client will send to the Server every 3 seconds if he is ready to for the next round
         the idea is that different clients take different time to render the game, so we will
         wait for all clients to render the map and the animations and then play next round */
      setInterval(() => { socket.emit('clientreadyfornextround',g_readyForNextRound)},3000);
    });
  </script>

</body>
</html>