<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Lokaverkefni</title>
  <link rel="stylesheet" href="./client/css/styles.css">
  <link rel="stylesheet" href="./client/css/fireworks.css">
</head>

<body>
  <div class="gameContainer">
    <div class="sideBar">
      
      <div class="Headerinn" id="headTitle"></div>
      <img class="heads" id="playerHeads">
      <div id="grad1">
        <div id="bar">
          <div id ="status"></div>
        </div>
      </div>
    </div>
    <canvas id="myCanvas" width="640" height="640" style="border: 1px solid black;"> Sorry, but your browser does not support the HTML5 canvas tag.</canvas>
  </div>
  <video id="myVideoBackground" src="/client/videos/frontPic.mp4" autoplay="" muted></video>
  <div class="winnerNote" id="winnerNoteID"></div>
  
   
  <div class="firstViewContainer" id="videoContainerinn">
      <video class="myVideo" src="/client/videos/frontPic.mp4" autoplay="" muted></video>
      <div class="players">
        <h2 id ="one"></h2>
        <h2 id ="two"></h2>
        <h2 id ="three"></h2>
        <div class="gameRules">
        <p>When the time start players click on tiles to move there character</p>
        <p>Button X enables your powerup and button R if all agree resets the game</p>
        <p>The objective is to get all the keys before the monster eats you</p>
      </div>
    </div>
      
    </div>
    <div class="fireWorksContainer" id = "fireWorksContainerID">
      <div class="pyro">
        <div class="before"></div>
        <div class="after"></div>
      </div>
    </div>
  <!-- ------------------HTML END SCRIPTS START --------------------------------------->

  <!-- We need this to communicate using socket.io from client side -->
  <script src="/socket.io/socket.io.js"></script>
  <script> 
    const g_canvas = document.getElementById("myCanvas");
    const g_ctx = g_canvas.getContext("2d");
    // establish our communication
    const socket = io();

    /* All global variables that are used by more than one class are here for ease of access */

    // the client id used to identify what player he is playing
    const sockid = socket.id;
    // tells us if the game is finished i.e game over or won
    let g_gameover = { over : false, winners:null };
    // client uses this to ping the serve that he is rdy for the next rounds
    let g_readyForNextRound = false;
    // client sents this to tell the serve that he has used a power up
    let g_usedPowerUp = false;
    // this turns players movements are stored here and sent to the server
    let g_steps=[];
    // the player that this client is playing as
    let player;
    // the game state that the user plays (all users get same gamestate)
    let g_gamestate = [];
    // if the game hasent started there is a waiting period that current players wait
    let g_waiting = [];

  </script>
  
  <!-- include all client game logic such as drawing the map waiting looby etc -->
  <script src="./client/js/imagesPreload.js"></script>
  <script src="./client/js/utils.js"></script>
  <script src="./client/js/playerMovement.js"></script>
  <script src="./client/js/handleMouse.js"></script>
  <script src="./client/js/Sprite.js"></script>
  <script src="./client/js/main.js"></script>
  <script src ="./client/js/firstView.js"></script>
  <script src="./client/js/progressBar.js"></script>
  <script src="./client/js/staminaScores.js"></script>
  <script src="./client/js/animation.js"></script>
  <script src="./client/js/audioPlayer.js"></script>
  <script src="./client/js/keys.js"></script>

 
  <!-- Combine all the game logic into a client side game -->
  <script>
    /* Define what happens when a socket manages to connect to our server */
    socket.on('connect', function() {
      // in here we can pass our socket.id to the functions that need it
      
      /* Next game round is send to us every x-seconds here we recive the map
      and call the necessary functions needed to draw the map based off 
      the data recived */
      drawPlayers();
      socket.on('NextGameRound', (data)=> {
        // we check if the data is a game state or a waiting lobby
        if (data.hasOwnProperty("__tiles")) {
          // check if the game is over  and the winners are player i.e suviors
          if(data.__gameWon.players){
             g_gameover.over = true;
             g_gameover.winners= "Suvivors";
             return;
          }
          // check if the game is over and the monster won the game 
          else if(data.__gameWon.monster) {
            g_gameover.over = true;
            g_gameover.winners= "Monster";
            return;
          }
          // if the game is not over then its clearly 
          else {
            // set the new game state so our clients can render it
            g_gamestate = data;
            // fetch the player 
            // player  to do 
            // set the lobby to empty
            g_waiting = [];
          }
          return;
        }
        // if we did not recive a game state we know we are in waiting lobby
        g_waiting = data;
      });

      socket.on('roundstart', ()=> {
        // when the round starts we allow the user to click on the tiles
        window.addEventListener("mousedown", handleMouse);
        window.addEventListener("mousemove", handleMouse);
        window.addEventListener("keydown", handleKeydown);

        player = getPlayer();
        setStamina(player);

        // start the count down that the user has 5 seconds to make a move
        startProgressBar();
        // declare that the client is not ready for the next round 
        // (NOT THIS ROUND BUT THE NEXT THAT IS YET TO BE CALCULATED AND RENDERED)
        g_readyForNextRound=false;
        
        /* Set a lambda function to go off in 5 seconds that will emit to the server what 
           has the user done, clearing the client side on what has he done and removing
           the listeners so he cant select the tiles*/
        setTimeout(() => {
          socket.emit('clientinput',{ steps:g_steps, powerUp:g_usedPowerUp});
          g_steps = [];
          g_usedPowerUp = false;
          window.removeEventListener("mousedown",handleMouse);
          window.removeEventListener("mousemove",handleMouse);
          window.removeEventListener("keydown",handleKeydown);
          moveMen();
        }, 5000);

      });

      /* client will send to the Server every 3 seconds if he is ready to for the next round
         the idea is that different clients take different time to render the game, so we will
         wait for all clients to render the map and the animations and then play next round */
      setInterval(() => { socket.emit('clientreadyfornextround',g_readyForNextRound)},3000);
    });
  </script>

</body>
</html>